name: Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  yaml-lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install yamllint
      run: |
        pip3 install --user yamllint
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Run YAML linting
      run: make lint-yaml

  shell-lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install shellcheck
      run: sudo apt-get update && sudo apt-get install -y shellcheck
    
    - name: Run shell script linting
      run: make lint-shell

  template-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate template references
      run: make validate-templates

  butane-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install podman
      run: |
        sudo apt-get update
        sudo apt-get install -y podman || {
          echo "Podman not available, using docker"
          sudo apt-get install -y docker.io
        }
    
    - name: Validate Butane configs
      run: make validate-butane

  systemd-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install systemd
      run: sudo apt-get update && sudo apt-get install -y systemd
    
    - name: Validate SystemD services
      run: make validate-systemd

  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Security scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: yaml,secrets
        quiet: true
        soft_fail: false
